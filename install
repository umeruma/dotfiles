#!/bin/bash

# If error was caused, stop script
set -e

# Install to ~/Codes/dotfiles instead of ~/.dotfiles
DOT_DIRECTORY="${HOME}/Codes/dotfiles"
REMOTE_URL="https://github.com/umeruma/dotfiles.git"

uname_s="$(uname -s)"

is_exist() {
	type "$1" > /dev/null 2>&1
}

install() {
	# Create ~/Codes directory if it doesn't exist
	mkdir -p "${HOME}/Codes"
	
	if [ -d "${DOT_DIRECTORY}" ]; then
		echo "DOTFILES have already been installed at ${DOT_DIRECTORY}"
	else 
		if is_exist "git"; then
			echo "Cloning dotfiles to ${DOT_DIRECTORY}..."
			git clone --recursive "${REMOTE_URL}" "${DOT_DIRECTORY}"
		else
			echo "git required"
			exit 1
		fi
	fi

	echo ""
	echo "Start to setup DOTFILES"
	echo ""

	cd "${DOT_DIRECTORY}"
	
	if [ "$uname_s" = "Linux" ]; then
		bash ./init/init-linux.sh
	fi

	if [ "$uname_s" = "Darwin" ]; then
		bash ./init/init-macos.sh
	fi

	if is_exist ./bin/just; then
		echo "just is installed"
		./bin/just --version || { echo "just command not working"; exit 1; }
	else
		# create ./bin
		mkdir -p ./bin

		# download and extract just to ./bin/just
		curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to ./bin

		# just should now be executable
		./bin/just --version || { echo "just install failed"; exit 1; }
		echo "just install succeeded"
	fi

	./bin/just install
}

install
